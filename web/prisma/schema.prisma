// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserStatus {
  ACTIVE
  DISABLED
  BANNED
}

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  passwordHash   String
  displayName    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  status         UserStatus @default(ACTIVE)

  // --- Activity tracking (for DAU/WAU/MAU) ---
  lastSeenAt     DateTime?
  lastSeenDayKey String?

  profile        Profile?
  sessions       Session[]

  // --- Telemetry ---
  events         Event[]

  // --- Feature flags overrides (opposite relation) ---
  featureFlagOverrides FeatureFlagOverride[]
}

model Profile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- Existing profile fields ---
  username  String?  @unique
  bio       String?
  city      String?
  state     String?
  avatarUrl String?

  setupDone Boolean  @default(false)

  // --- URA birth data (source of truth) ---
  birthYear   Int?
  birthMonth  Int?
  birthDay    Int?
  birthHour   Int?
  birthMinute Int?

  birthLat    Float?
  birthLon    Float?
  birthPlace  String?
  timezone    String  @default("America/New_York")

  // --- Cached computed data (JSON blobs, flexible) ---
  natalChartJson Json?
  natalUpdatedAt DateTime?

  // --- Daily “as-of” caches (Asc Year + Lunation) ---
  asOfDate       DateTime?
  ascYearJson    Json?
  lunationJson   Json?
  dailyUpdatedAt DateTime?

  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
}

// --- Admin audit trail (unlock/lock + future admin operations) ---
model AdminAuditLog {
  id        Int      @id @default(autoincrement())
  action    String
  actor     String   @default("admin")
  ip        String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([action])
}

// ------------------------------------------------------------------
// TELEMETRY (page views, feature usage, errors, timings)
// ------------------------------------------------------------------
model Event {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())

  // taxonomy
  type         String   // "pageview" | "feature" | "error" | "timing" | "api"
  name         String?  // e.g. "profile.save", "moon.render", "api:/api/seen"
  path         String?  // e.g. "/profile"
  severity     String?  // "info" | "warn" | "error"

  // optional linkage
  userId       Int?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // for anonymous or semi-anonymous grouping
  sessionToken String?  // your Session.token or a client-generated anon id

  // metrics
  durationMs   Int?
  statusCode   Int?

  // flexible metadata
  meta         Json?

  @@index([createdAt])
  @@index([type])
  @@index([path])
  @@index([userId])
  @@index([type, name])
}

// ------------------------------------------------------------------
// FEATURE FLAGS / KILL SWITCHES
// ------------------------------------------------------------------
model FeatureFlag {
  id          Int      @id @default(autoincrement())
  key         String   @unique // e.g. "moon_page", "gann_chart", "doctrine_v2"
  description String?
  enabled     Boolean  @default(false)
  payload     Json?    // optional config
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  overrides   FeatureFlagOverride[]
}

model FeatureFlagOverride {
  id        Int      @id @default(autoincrement())
  flagId    Int
  userId    Int

  flag      FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  enabled   Boolean
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([flagId, userId])
  @@index([userId])
  @@index([flagId])
}

// ------------------------------------------------------------------
// HEALTH CHECKS (DB / polygon / ephemeris / etc.)
// ------------------------------------------------------------------
model HealthCheck {
  id         Int      @id @default(autoincrement())
  checkedAt  DateTime @default(now())

  serviceKey String   // "db" | "polygon" | "ephemeris" | "app"
  ok         Boolean
  latencyMs  Int?
  details    Json?

  @@index([checkedAt])
  @@index([serviceKey])
}

// ------------------------------------------------------------------
// DAILY BRIEF CACHE (one per user per local day)
// ------------------------------------------------------------------
model DailyBriefCache {
  id          Int      @id @default(autoincrement())
  userId      Int
  ymdLocal    String   // YYYY-MM-DD in user's timezone
  payloadJson Json     // Full brief response including element + story
  createdAt   DateTime @default(now())

  @@unique([userId, ymdLocal])
  @@index([userId])
  @@index([ymdLocal])
}
