// prisma/schema.prisma
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  passwordHash   String
  displayName    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // --- Activity tracking (for DAU/WAU/MAU) ---
  lastSeenAt     DateTime?
  lastSeenDayKey String?

  profile        Profile?
  sessions       Session[]
}

model Profile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- Existing profile fields ---
  username  String?  @unique
  bio       String?
  city      String?
  state     String?
  avatarUrl String?

  setupDone Boolean  @default(false)

  // --- URA birth data (source of truth) ---
  birthYear   Int?
  birthMonth  Int?
  birthDay    Int?
  birthHour   Int?
  birthMinute Int?

  birthLat    Float?
  birthLon    Float?
  birthPlace  String? // e.g. "Raleigh, NC" (optional display label)
  timezone    String  @default("America/New_York")

  // --- Cached computed data (JSON blobs, flexible) ---
  natalChartJson Json?
  natalUpdatedAt DateTime?

  // --- Daily “as-of” caches (Asc Year + Lunation) ---
  // Anchor date used to determine whether today’s caches are up-to-date.
  // We’ll treat this as the last refresh date; compare day keys in the user’s timezone in code.
  asOfDate       DateTime?
  ascYearJson    Json?
  lunationJson   Json?
  dailyUpdatedAt DateTime?

  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
}

// --- Admin audit trail (unlock/lock + future admin operations) ---
model AdminAuditLog {
  id        Int      @id @default(autoincrement())
  action    String
  actor     String   @default("admin")
  ip        String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([action])
}
